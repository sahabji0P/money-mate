name: CI/CD Deploy to Server

on:
  push:
    branches:
      - master   # Triggers workflow on push to master branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        # Pulls your repo code into the GitHub runner

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          name: id_rsa               # Default name is id_rsa; you can omit
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          if_key_exists: replace     # Overwrites if already present
        # Installs SSH key and registers known_hosts for strict SSH

      # If you donâ€™t want to use a known_hosts secret, you can dynamically set it:
      - name: Add server to known_hosts
        run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        # This step can be omitted if you provided known_hosts in the install SSH key step

      - name: Deploy Application
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd $APP_DIR && git pull origin master && npm install && npm run build"
        # Connects to the server and runs your deployment commands
